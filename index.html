<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body { margin:0; font-family:Arial; background:#121212; color:#fff; }
  .section { display:none; padding:20px; }
  .section.active { display:block; }
  .nav-btn { background:#007bff; color:#fff; border:none; padding:10px 14px;
    border-radius:8px; margin:5px; cursor:pointer; }
  .user-info-card { background:#2b2b2b; border-radius:10px; padding:10px;
    display:flex; align-items:center; margin-bottom:20px; }
  .user-info-card img { border-radius:50%; width:60px; height:60px; margin-right:15px; }
  .nav-bar { position:fixed; bottom:10px; width:100%; background:#1e1e1e;
    display:flex; justify-content:space-around; padding:8px 0; }
</style>
</head>
<body>

<div id="home" class="section active">
  <div class="user-info-card">
    <img id="user-avatar" src="https://placehold.it/60x60" alt="User Avatar">
    <div>
      <div id="user-name">Loading...</div>
      <div id="user-username"></div>
      <div>Points: <span id="user-points">0</span></div>
    </div>
  </div>
  <div><strong>Invite your friends:</strong>
    <div id="invite-link" style="word-break:break-word;margin:8px 0;"></div>
    <button class="nav-btn" onclick="copyInviteLink()">Copy Invite Link</button>
  </div>
</div>

<div id="earn" class="section">
  <h3>Earn Points</h3>
  <button class="nav-btn" onclick="addPoints(50)">+50 Points</button>
</div>

<div id="referral" class="section">
  <h3>Referral Info</h3>
  <p>Invite friends & get 100 points!</p>
</div>

<div id="balance" class="section">
  <h3>Your Points Balance</h3>
  <div style="font-size:24px;font-weight:bold" id="user-points-balance">0</div>
</div>

<div class="nav-bar">
  <button class="nav-btn" onclick="showSection('home')">üè† Home</button>
  <button class="nav-btn" onclick="showSection('earn')">üí∞ Earn</button>
  <button class="nav-btn" onclick="showSection('referral')">üë• Referral</button>
  <button class="nav-btn" onclick="showSection('balance')">üî¢ Balance</button>
</div>

<script>
const API_URL = "https://miniapp-backend-ax0y2mm08-haki-web-5844s-projects.vercel.app";
const botUsername = "New003bot";

function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='home'||id==='balance') updatePoints();
}

async function addPoints(amount){
  const tg = window.Telegram.WebApp;
  const userId = tg.initDataUnsafe?.user?.id?.toString() || "guest";
  await fetch(`${API_URL}/add_points`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({user_id:userId,amount:amount})
  });
  alert(`+${amount} points added!`);
  updatePoints();
}

async function updatePoints(){
  const tg = window.Telegram.WebApp;
  const userId = tg.initDataUnsafe?.user?.id?.toString() || "guest";
  const res = await fetch(`${API_URL}/points/${userId}`);
  const data = await res.json();
  document.getElementById("user-points").textContent = data.points;
  document.getElementById("user-points-balance").textContent = data.points;
}

function copyInviteLink(){
  const link=document.getElementById("invite-link").textContent;
  navigator.clipboard.writeText(link).then(()=>alert("‚úÖ Copied!"));
}

function checkReferral(){
  const urlParams=new URLSearchParams(window.location.search);
  const referrerId=urlParams.get("start");
  const tg=window.Telegram.WebApp;
  const newUserId=tg.initDataUnsafe?.user?.id?.toString();
  if(referrerId&&newUserId&&referrerId!==newUserId){
    fetch(`${API_URL}/referral`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_id:referrerId,referral_id:newUserId})
    }).then(r=>r.json()).then(d=>{
      console.log("Referral response:",d);
      updatePoints();
    });
  }
}

const tg = window.Telegram.WebApp;
tg.ready();
console.log("üîç Full Init Data:", tg.initDataUnsafe);

const user = tg.initDataUnsafe?.user;
if(user){
  document.getElementById('user-name').textContent=`Hello, ${user.first_name}`;
  document.getElementById('user-username').textContent=`@${user.username||'No Username'}`;
  document.getElementById('user-avatar').src=user.photo_url||'https://placehold.it/60x60';
  document.getElementById("invite-link").textContent=`https://t.me/${botUsername}?start=${user.id}`;
}else{
  console.warn("‚ö†Ô∏è No user data - Open in Telegram App");
}

checkReferral();
updatePoints();
</script>
</body>
</html>
